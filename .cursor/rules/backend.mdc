---
description: backend
alwaysApply: false
---
# Cursor Rules for TenderFlow KB AI Backend

## Общий контекст проекта
- Проект: TenderFlow KB AI — платформа для тендеров (редукторы, расчеты цен). Модули: Tender Management (жизненный цикл, дедлайны), Pricing KB AI (хранение расчетов, AI-поиск, RAG), DocFlow (генерация ТКП, автозаполнение форм, ЭП).
- Технологический стек: Python 3.11, FastAPI 0.110+, PostgreSQL 16 + pgvector 0.7+ (векторный поиск), Redis 7 + Celery 5 + Flower (кеш, очереди), MinIO (S3 для файлов/чертежей), AI: Claude 3.5 Sonnet / GPT-4o (API), OpenAI text-embedding-3-large (3072 dim), LangChain 0.2+ / LlamaIndex 0.11+ (RAG), OCR/CV: OpenCV + YOLOv11 + EasyOCR/Donut (fine-tuned, >90% acc для чертежей).
- Сущности из глоссария: Тендер, ЭТП, ТЗ, ТКП, Редуктор (стандартный/нестандартный), КД, Позиция, БГ, ЭП, OCR, RAG, Embedding, AI-ассистент, Канбан-доска.
- Ключевые сценарии: Создание тендера с позициями, AI-поиск похожих расчетов (векторный + NLP), копирование расчета, генерация ТКП/пакета (Word/PDF/Zip с ЭП), OCR чертежей (извлечение params: тип, i, мощность), дашборд аналитики, постобработка результатов (анализ цен).
- Нефункциональные: Поиск <2 сек (10k+ записей), AI-ответ <5 сек, OCR <30 сек, безопасность (OAuth/LDAP, шифрование), uptime 99%, масштабируемость до 50k расчетов/50 users.

## Правила генерации кода
- Всегда используй Python 3.11: строгий typing (Type Hints, Pydantic для моделей/валидации). No any, используй dataclasses или Pydantic BaseModel для сущностей (e.g., class Tender(BaseModel): id: str; status: Literal['Новый', 'Расчёт']; positions: List[Position];).
- Структура: app/routers (эндпоинты: tenders.py, calculations.py, ai_search.py), app/models (SQLAlchemy: Tender, Calculation с pgvector Vector для embeddings), app/schemas (Pydantic: TenderCreate, CalculationResponse), app/services (логика: ai_search_service с LangChain), app/tasks (Celery: ocr_task для чертежей), app/utils (helpers: embedding_generator).
- FastAPI: APIRouter для модулей. Dependencies: auth (OAuth2), db_session. Responses: JSON с Pydantic, файлы (FileResponse для ТКП PDF/Zip).
- **OpenAPI документация**: Все эндпоинты должны иметь полные описания в docstrings и Pydantic моделях. Используй `tags`, `summary`, `description`, `response_model` для автогенерации OpenAPI спецификации. Пример: `@router.post("/tenders", tags=["tenders"], summary="Создать тендер", response_model=TenderResponse)`.
- **OpenAPI Generator**: После добавления/изменения эндпоинтов запускай генерацию TypeScript клиента: `openapi-generator-cli generate -i http://localhost:8000/openapi.json -g typescript-axios -o frontend/src/api/generated --additional-properties=supportsES6=true,typescriptThreePlus=true`. Спецификация доступна по `/openapi.json` и `/docs` (Swagger UI).
- БД: SQLAlchemy async с PostgreSQL. Векторный поиск: query = select(Calculation).order_by(Calculation.embedding.cosine_distance(embedding_query)).limit(5).
- AI/RAG: LangChain для chain (retriever от pgvector, prompt для Claude/GPT). Embeddings: OpenAI API. Для ассистента: chain.invoke({"query": user_input, "context": retrieved_docs}).
- OCR/CV: Celery task: yolo.detect_objects(image) -> easyocr.read_text(rotated_boxes) -> extract_params (тип редуктора, i=50, etc.) -> JSON.
- Файлы: MinIO client для upload/download чертежей (PDF/DWG/STEP). Генерация docs: docxtpl для Word ТКП, PyPDF2 для PDF, zipfile для пакетов.
- Tasks/Queues: Celery для async (OCR, генерация ТКП <90 сек). Redis для кэша (e.g., redis.set('tender:123', json.dumps(data), ex=300)).
- Сценарии-specific:
  - Тендер создание: POST /tenders -> create_tender(db, files=UploadFile[] for ТЗ/чертежи) -> MinIO upload -> pg insert.
  - AI-поиск: GET /search?query="червячный редуктор i=50" -> generate_embedding -> pgvector query -> LLM rank (Claude: "Ранжируй по релевантности").
  - Генерация ТКП: POST /generate_tkp/{tender_id} -> Celery task -> render_docx(template, data) -> sign_ep (CryptoPro sim) -> return FileResponse.
  - Дашборд: GET /analytics -> aggregate (выигранные/проигранные, загрузка users) с SQL queries.
  - Уведомления: Celery beat для дедлайнов (email/Telegram via smtp/aiohttp).

## Правила рефакторинга и дебаггинга
- Рефактор: Улучшай typing, удаляй unused imports, оптимизируй queries (indexes на pgvector). Async где возможно (e.g., async def endpoint).
- Дебаг: Предлагай logging (logging.info), pytest для тестов. Для ошибок: check db connections, API keys (env: ANTHROPIC_API_KEY).
- Безопасность: Validate inputs (Pydantic), rate limiting (slowapi), encrypt sensitive (расчеты цен: Fernet). Roles: depends on user_role (admin, engineer).

## Стиль и конвенции
- Форматирование: Black (line-length=88), isort. Pylint: score >9/10.
- Коммиты: Conventional commits (feat:, fix:). Branches: feature/ai-search.
- Тесты: Pytest для units (services), integration (API с TestClient), mocks для AI/API (responses.add).
- Env: .env для secrets (DB_URL, OPENAI_API_KEY, MINIO_ROOT_USER).
- **OpenAPI спецификация**: Храни в `backend/openapi.json` (экспорт из FastAPI). Обновляй при изменении API. Используй версионирование: `/api/v1/` для эндпоинтов.

## Ограничения
- Не генерируй frontend-код (React) здесь — только backend.
- Учитывай NFR: <2 сек на поиск — индексы на pgvector, кэш Redis.
- Конфиденциальность: No hard-coded data, шифруй чертежи в MinIO.
- Если промпт неясен, уточни: "Уточните сценарий из scenarios.md".


backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI app creation
│   ├── config.py            # Pydantic Settings
│   ├── models/              # SQLAlchemy models
│   ├── modules/             # Feature modules
│   │   ├── pricing_kb_ai/
│   │   │   ├── __init__.py
│   │   │   ├── routes.py    # API endpoints
│   │   │   ├── service.py   # Business logic
│   │   │   ├── repository.py # DB operations
│   │   │   ├── schemas.py   # Pydantic models
│   │   │   └── ai/
│   │   │       ├── embeddings.py
│   │   │       ├── rag_pipeline.py
│   │   │       └── drawing_processor.py
│   ├── core/                # Shared components
│   └── db/                  # DB connection, migrations
├── tests/
└── requirements.txt