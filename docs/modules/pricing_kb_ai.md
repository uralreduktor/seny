# Модуль базы знаний по ценообразованию с AI (Pricing KB AI)

## Обзор

Модуль Pricing KB AI обеспечивает централизованное хранение расчётов стоимости, интеллектуальный поиск похожих проектов и помощь инженерам через AI-ассистента.

## Основные функции

### 1. Хранение расчётов стоимости

**Типы расчётов**:
- Стандартные редукторы
- Нестандартные редукторы
- Мотор-редукторы
- Шестерни
- Специальные комплектующие
- Конструкторская документация (КД)

**Структура расчёта**:
- Параметры оборудования (мощность, передаточное число, тип)
- Материалы и комплектующие
- Трудозатраты по операциям
- Накладные расходы
- Маржа
- Итоговая стоимость

**Метаданные**:
- Дата создания и автор
- Связь с тендером
- Версия расчёта
- Статус (черновик, утверждён, использован)

### 2. Прикрепление файлов

**Поддерживаемые форматы**:
- Чертежи: PDF, DWG, STEP
- Документы: Word, Excel, PDF
- Изображения: PNG, JPG

**Функциональность**:
- Загрузка файлов в MinIO
- Версионирование файлов
- Предпросмотр чертежей
- Связь файлов с расчётами

### 3. Векторный поиск

**Технология**: RAG (Retrieval-Augmented Generation) с использованием pgvector

**Типы поиска**:
- **По параметрам**: мощность, передаточное число, тип редуктора
- **По естественному языку**: "червячный редуктор i=50"
- **Семантический поиск**: поиск по смыслу, а не точному совпадению

**Процесс поиска**:
1. Пользователь вводит запрос
2. Генерация embedding через OpenAI text-embedding-3-large
3. Векторный поиск в pgvector (cosine similarity)
4. Ранжирование результатов
5. Отображение топ-N похожих расчётов

**Метрики**:
- Время поиска: <2 секунды
- Точность: >70% релевантных результатов в топ-5

### 4. OCR и Computer Vision для чертежей

**Назначение**: Автоматическое извлечение параметров из чертежей

**Технологии**:
- **YOLOv11**: детекция объектов (текстовые блоки, размеры, таблицы)
- **EasyOCR**: распознавание текста

**Процесс обработки**:
1. Загрузка чертежа
2. Конвертация в изображение (если необходимо)
3. Детекция объектов через YOLOv11
4. Распознавание текста через EasyOCR
5. Извлечение параметров (мощность, передаточное число и т.д.)
6. Сохранение структурированных данных

**Метрики**:
- Точность OCR: >90% для печатного текста
- Время обработки: <600 секунд
- Извлечение параметров: >80% ключевых параметров

### 5. AI-ассистент

**Возможности**:
- Проверка расчётов на ошибки
- Предложения по оптимизации стоимости
- Объяснение методик расчёта
- Ответы на вопросы по ценообразованию
- Поиск похожих проектов с объяснениями

**Технологии**:
- **LLM**: Claude 3.5 Sonnet (основной), GPT-4o (резерв)
- **RAG**: LangChain 0.2+ или LlamaIndex 0.11+
- **Контекст**: база знаний расчётов

**Примеры запросов**:
- "Проверь мой расчёт на ошибки"
- "Найди похожие проекты с передаточным числом 50"
- "Как рассчитать стоимость для червячного редуктора?"
- "Какая маржа обычно используется для таких проектов?"

### 6. Прогнозирование стоимости

**Назначение**: Предсказание стоимости позиции на основе исторических данных

**Подход**:
- Анализ исторических расчётов
- Учёт параметров оборудования
- Корректировка на инфляцию
- Учёт рыночных условий

**Метрики точности**:
- Средняя ошибка прогноза: <15%
- Уверенность модели: отображается для каждого прогноза

### 7. Шаблоны расчётов

**Функциональность**:
- Создание шаблонов для типовых позиций
- Использование шаблонов для быстрого создания расчётов
- Версионирование шаблонов
- Наследование параметров из шаблона

**Типы шаблонов**:
- По типу оборудования (редуктор, мотор-редуктор)
- По технологии производства
- По заказчику (специфические требования)

### 8. Технологические маршруты

**Функциональность**:
- Хранение последовательности операций производства
- Связь с расчётами стоимости
- Шаблоны технологических маршрутов
- Оценка трудозатрат по операциям

## API Endpoints

### Расчёты

- `GET /api/v1/calculations` — список расчётов (с фильтрацией)
- `GET /api/v1/calculations/{id}` — детали расчёта
- `POST /api/v1/calculations` — создание расчёта
- `PUT /api/v1/calculations/{id}` — обновление расчёта
- `DELETE /api/v1/calculations/{id}` — удаление расчёта
- `POST /api/v1/calculations/{id}/clone` — клонирование расчёта

### Поиск

- `POST /api/v1/search/similar` — поиск похожих расчётов (векторный)
- `POST /api/v1/search/parameters` — поиск по параметрам
- `GET /api/v1/search/history` — история поисковых запросов

### OCR

- `POST /api/v1/ocr/process` — обработка чертежа (асинхронно)
- `GET /api/v1/ocr/tasks/{task_id}` — статус задачи OCR
- `GET /api/v1/ocr/results/{task_id}` — результаты OCR

### AI-ассистент

- `POST /api/v1/ai/assistant/query` — запрос к AI-ассистенту
- `POST /api/v1/ai/assistant/validate` — проверка расчёта
- `POST /api/v1/ai/assistant/suggest` — предложения по оптимизации

### Шаблоны

- `GET /api/v1/templates` — список шаблонов
- `GET /api/v1/templates/{id}` — детали шаблона
- `POST /api/v1/templates` — создание шаблона
- `POST /api/v1/templates/{id}/apply` — применение шаблона к расчёту

## Модели данных

### Calculation (Расчёт)

```python
class Calculation(Base):
    id: int
    title: str
    equipment_type: str  # редуктор, мотор-редуктор, шестерня
    parameters: JSON  # мощность, передаточное число и т.д.
    materials: JSON  # список материалов
    labor_costs: JSON  # трудозатраты
    overhead: Decimal  # накладные расходы
    margin: Decimal  # маржа
    total_cost: Decimal  # итоговая стоимость
    tender_id: int  # связь с тендером
    author_id: int
    embedding: Vector  # векторное представление для поиска
    created_at: datetime
    updated_at: datetime
```

### Drawing (Чертеж)

```python
class Drawing(Base):
    id: int
    calculation_id: int
    file_path: str  # путь в MinIO
    file_type: str  # PDF, DWG, STEP
    extracted_parameters: JSON  # извлечённые параметры
    ocr_status: str  # pending, processing, completed, failed
    ocr_task_id: str  # ID задачи Celery
    created_at: datetime
```

## Интеграции

### Интеграция с модулем Tender Management

- Связь расчётов с тендерами
- Автоматическое создание расчёта при переходе тендера в стадию "Расчёт стоимости"

### Интеграция с модулем DocFlow

- Использование данных расчёта для генерации ТКП
- Автозаполнение форм на основе расчёта

## Пользовательские сценарии

### Сценарий 1: Поиск похожего расчёта

1. Инженер вводит запрос: "червячный редуктор i=50 мощность 5 кВт"
2. Система генерирует embedding и выполняет векторный поиск
3. Отображаются топ-5 похожих расчётов с процентом совпадения
4. Инженер выбирает подходящий расчёт и клонирует его
5. Вносит изменения под новый проект

### Сценарий 2: Обработка чертежа

1. Инженер загружает чертёж в формате PDF
2. Система создаёт задачу OCR в Celery
3. Фоновая обработка: YOLOv11 + EasyOCR
4. Извлечённые параметры сохраняются в БД
5. Инженер получает уведомление о завершении
6. Просматривает извлечённые параметры и корректирует при необходимости

### Сценарий 3: Использование AI-ассистента

1. Инженер завершает расчёт и нажимает "Проверить через AI"
2. AI-ассистент анализирует расчёт с использованием RAG
3. Проверяет на типичные ошибки
4. Предлагает оптимизации
5. Объясняет методику расчёта
6. Инженер принимает или отклоняет предложения

---

**Связанные документы:**
- [AI компоненты](../architecture/ai_components.md)
- [Архитектура системы](../architecture/system_architecture.md)
- [Валидация AI компонентов](../testing/ai_validation.md)

