# Модуль подготовки тендерной документации (DocFlow)

## Обзор

Модуль DocFlow автоматизирует подготовку тендерной документации: от автозаполнения форм заказчика до генерации технико-коммерческих предложений и комплектования пакетов документов для подачи на ЭТП.

## Основные функции

### 1. Библиотека шаблонов документов

**Типы шаблонов**:
- Формы заказчиков (ЕИС, Сбербанк-АСТ, Росэлторг)
- Коммерческие ЭТП
- Корпоративные формы
- Внутренние шаблоны ТКП

**Функциональность**:
- Загрузка шаблонов в редактируемом виде (Word, Excel, PDF)
- Разметка полей для автозаполнения
- Версионирование шаблонов
- Категоризация по заказчикам и типам документов

**Форматы**:
- Microsoft Word (.docx)
- Microsoft Excel (.xlsx)
- PDF (с возможностью редактирования через специальные инструменты)

### 2. Автозаполнение форм

**Источники данных**:
- Расчёт стоимости из модуля Pricing KB AI
- Данные тендера из модуля Tender Management
- Карточка компании (реквизиты, контакты)
- История предыдущих заполнений

**Процесс автозаполнения**:
1. Выбор шаблона формы
2. Связь с расчётом и тендером
3. Извлечение данных из связанных сущностей
4. Автоматическое заполнение полей в форме
5. Предпросмотр заполненной формы
6. Ручная корректировка при необходимости
7. Сохранение заполненной формы

**Поддерживаемые поля**:
- Текстовые поля
- Таблицы (списки позиций)
- Числовые значения (стоимость, количество)
- Даты
- Выпадающие списки

### 3. Генерация ТКП

**Функциональность**:
- Генерация технико-коммерческого предложения в один клик
- Использование фирменного стиля компании
- Автоматическое включение данных из расчёта
- Формирование в форматах Word и PDF

**Структура ТКП**:
- Титульная страница
- Технические характеристики оборудования
- Коммерческие условия (цена, сроки поставки, гарантия)
- Приложения (чертежи, сертификаты)

**Процесс генерации**:
1. Выбор тендера и расчёта
2. Нажатие кнопки "Сформировать ТКП"
3. Система подтягивает все данные
4. Генерация документа за <2 минут
5. Предпросмотр и возможность редактирования
6. Сохранение в MinIO

### 4. Комплектование пакета документов

**Обязательные документы**:
- Технико-коммерческое предложение (ТКП)
- Расчёт стоимости
- Чертежи и техническая документация
- Сертификаты соответствия
- Доверенность на подписание
- Банковская гарантия (если требуется)
- Прочие документы по требованиям заказчика

**Функциональность**:
- Чек-лист обязательных документов для тендера
- Автоматический сбор документов из системы
- Проверка полноты пакета
- Формирование zip-архива
- Версионирование пакетов

**Процесс комплектования**:
1. Открытие карточки тендера
2. Нажатие "Скачать полный пакет для подачи"
3. Система собирает все связанные документы
4. Проверка на полноту (чек-лист)
5. Формирование структурированного zip-архива
6. Скачивание готового пакета

### 5. Электронная подпись

**Интеграции**:
- КриптоПро
- Рутокен

**Функциональность**:
- Подписание документов прямо в системе
- Массовое подписание пакета документов
- Проверка подписей
- Хранение сертификатов

**Процесс подписания**:
1. Выбор документа(ов) для подписания
2. Подключение токена (Рутокен) или использование КриптоПро
3. Ввод PIN-кода
4. Подписание документа
5. Сохранение подписанного документа

### 6. Экспорт на ЭТП

**Функциональность**:
- Прямой экспорт комплекта в форматы ЭТП
- Подготовка zip-архива по требованиям площадки
- Валидация документов перед экспортом
- История экспортов

**Поддерживаемые ЭТП**:
- ЕИС (XML формат)
- Сбербанк-АСТ
- Росэлторг
- Другие коммерческие площадки

### 7. Версионирование документации

**Функциональность**:
- История всех версий ТКП и форм
- Возможность отката к предыдущей версии
- Сравнение версий
- Комментарии к версиям

**Метаданные версий**:
- Дата создания
- Автор изменений
- Причина изменений
- Статус версии (черновик, финальная, отправлена)

## API Endpoints

### Шаблоны

- `GET /api/v1/templates` — список шаблонов документов
- `GET /api/v1/templates/{id}` — детали шаблона
- `POST /api/v1/templates` — загрузка шаблона
- `PUT /api/v1/templates/{id}` — обновление шаблона
- `DELETE /api/v1/templates/{id}` — удаление шаблона

### Автозаполнение

- `POST /api/v1/documents/fill` — автозаполнение формы
- `GET /api/v1/documents/{id}/preview` — предпросмотр заполненного документа
- `POST /api/v1/documents/{id}/save` — сохранение заполненного документа

### Генерация ТКП

- `POST /api/v1/tkp/generate` — генерация ТКП (асинхронно)
- `GET /api/v1/tkp/tasks/{task_id}` — статус задачи генерации
- `GET /api/v1/tkp/{id}` — получение сгенерированного ТКП
- `GET /api/v1/tkp/{id}/download` — скачивание ТКП

### Комплектование пакета

- `POST /api/v1/packages/create` — создание пакета документов
- `GET /api/v1/packages/{id}` — детали пакета
- `GET /api/v1/packages/{id}/download` — скачивание zip-архива
- `POST /api/v1/packages/{id}/validate` — проверка полноты пакета

### Электронная подпись

- `POST /api/v1/sign/sign` — подписание документа
- `POST /api/v1/sign/batch` — массовое подписание
- `GET /api/v1/sign/verify/{id}` — проверка подписи

### Версионирование

- `GET /api/v1/documents/{id}/versions` — история версий документа
- `POST /api/v1/documents/{id}/restore` — откат к версии
- `GET /api/v1/documents/{id}/compare` — сравнение версий

## Модели данных

### DocumentTemplate (Шаблон документа)

```python
class DocumentTemplate(Base):
    id: int
    name: str
    type: str  # форма заказчика, ТКП, прочее
    customer: str  # заказчик (если применимо)
    file_path: str  # путь в MinIO
    file_type: str  # Word, Excel, PDF
    fields: JSON  # разметка полей для автозаполнения
    version: int
    created_at: datetime
    updated_at: datetime
```

### Document (Документ)

```python
class Document(Base):
    id: int
    template_id: int
    tender_id: int
    calculation_id: int  # связь с расчётом
    type: str  # ТКП, форма заказчика, прочее
    file_path: str  # путь к заполненному документу
    version: int
    signed: bool  # подписан ли документ
    signature_path: str  # путь к подписи (если есть)
    created_at: datetime
    updated_at: datetime
```

### DocumentPackage (Пакет документов)

```python
class DocumentPackage(Base):
    id: int
    tender_id: int
    documents: JSON  # список ID документов
    zip_path: str  # путь к zip-архиву
    status: str  # preparing, ready, sent
    created_at: datetime
```

## Интеграции

### Интеграция с модулем Tender Management

- Получение данных тендера для автозаполнения
- Связь документов с тендером
- Обновление статуса тендера при отправке документов

### Интеграция с модулем Pricing KB AI

- Использование данных расчёта для генерации ТКП
- Автозаполнение коммерческих разделов на основе расчёта

### Интеграция с внешними системами

- КриптоПро / Рутокен для электронной подписи
- API ЭТП для прямого экспорта (планируется)

## Пользовательские сценарии

### Сценарий 1: Генерация ТКП в один клик

1. Инженер завершил расчёт стоимости
2. Нажимает кнопку "Сформировать ТКП"
3. Система подтягивает все данные из расчёта и тендера
4. Генерирует документ в фирменном стиле за <2 минут
5. Инженер просматривает ТКП и вносит правки при необходимости
6. Сохраняет финальную версию

### Сценарий 2: Автозаполнение формы заказчика

1. Менеджер открывает карточку тендера
2. Выбирает форму заказчика из библиотеки шаблонов
3. Система автоматически заполняет форму данными из расчёта и тендера
4. Менеджер проверяет заполнение и корректирует при необходимости
5. Сохраняет заполненную форму

### Сценарий 3: Комплектование и подписание пакета

1. Менеджер открывает карточку тендера
2. Нажимает "Скачать полный пакет для подачи"
3. Система собирает все документы: ТКП, расчёт, чертежи, сертификаты
4. Проверяет полноту пакета по чек-листу
5. Формирует zip-архив
6. Менеджер подписывает документы через Рутокен
7. Скачивает готовый подписанный пакет для подачи на ЭТП

---

**Связанные документы:**
- [Модуль управления торгами](./tender_management.md)
- [Модуль базы знаний](./pricing_kb_ai.md)
- [API документация](../development/api_docs.md)

