# AI/ML компоненты системы

## Обзор

Система TenderFlow KB AI использует современные AI/ML технологии для интеллектуального поиска, анализа чертежей и помощи инженерам в расчётах стоимости.

## Компоненты

### 1. RAG (Retrieval-Augmented Generation)

**Назначение**: Интеллектуальный поиск похожих расчётов и ответы на вопросы инженеров с использованием контекста из базы знаний.

**Архитектура**:
```
Запрос пользователя
    │
    ├─→ Генерация embedding (OpenAI text-embedding-3-large)
    │
    ├─→ Векторный поиск в pgvector (похожие расчёты)
    │
    ├─→ Ранжирование результатов
    │
    └─→ Генерация ответа (Claude 3.5 Sonnet) с контекстом
```

**Технологии**:
- **Embeddings**: OpenAI text-embedding-3-large (3072 размерности)
- **Хранение**: PostgreSQL + pgvector
- **RAG Framework**: LangChain 0.2+ или LlamaIndex 0.11+
- **LLM**: Claude 3.5 Sonnet (основной), GPT-4o (резерв)

**Метрики качества**:
- Точность поиска: >70% релевантных результатов в топ-5
- Время отклика: <2 секунды
- Качество ответов: оценка пользователями >4/5

### 2. OCR и Computer Vision для чертежей

**Назначение**: Автоматическое извлечение параметров и текста из чертежей (PDF, DWG, STEP).

**Архитектура**:
```
Загрузка чертежа
    │
    ├─→ Конвертация в изображение (если необходимо)
    │
    ├─→ Детекция объектов (YOLOv11)
    │   └─→ Обнаружение текстовых блоков, размеров, таблиц
    │
    ├─→ Распознавание текста (EasyOCR)
    │   └─→ Извлечение параметров (мощность, передаточное число и т.д.)
    │
    └─→ Сохранение структурированных данных в БД
```

**Технологии**:
- **Детекция объектов**: YOLOv11
- **OCR**: EasyOCR
- **Обработка**: Python + OpenCV

**Метрики качества**:
- Точность OCR: >90% для печатного текста
- Время обработки: <600 секунд для сложного чертежа
- Извлечение параметров: >80% ключевых параметров

### 3. AI-ассистент

**Назначение**: Помощь инженерам в расчётах стоимости, проверке корректности данных, подсказки по методикам.

**Возможности**:
- Проверка расчётов на ошибки
- Предложения по оптимизации стоимости
- Объяснение методик расчёта
- Прогнозирование стоимости на основе исторических данных

**Технологии**:
- **LLM**: Claude 3.5 Sonnet (основной)
- **Контекст**: RAG из базы знаний
- **Интеграция**: FastAPI endpoints для взаимодействия

**Примеры использования**:
1. "Проверь мой расчёт на ошибки"
2. "Найди похожие проекты с передаточным числом 50"
3. "Как рассчитать стоимость для червячного редуктора?"

### 4. Прогнозирование стоимости

**Назначение**: Предсказание стоимости позиции на основе исторических данных и параметров.

**Подход**:
- Анализ исторических расчётов
- Учёт параметров оборудования (мощность, передаточное число, тип)
- Корректировка на инфляцию и рыночные условия

**Технологии**:
- Машинное обучение (планируется)
- Статистический анализ
- Интеграция с внешними источниками данных о ценах

## Интеграция компонентов

### Поток данных для AI-поиска

```python
# Псевдокод
async def search_similar_calculations(query: str, db: AsyncSession):
    # 1. Генерация embedding
    embedding = await openai_client.embeddings.create(
        model="text-embedding-3-large",
        input=query
    )
    
    # 2. Векторный поиск в pgvector
    results = await db.execute(
        select(Calculation)
        .order_by(Calculation.embedding.cosine_distance(embedding))
        .limit(5)
    )
    
    # 3. RAG через LangChain
    chain = create_rag_chain(llm=claude_client)
    answer = await chain.ainvoke({
        "query": query,
        "context": format_calculations(results)
    })
    
    return answer, results
```

### Поток данных для OCR

```python
# Псевдокод
async def process_drawing(file_path: str):
    # 1. Загрузка и предобработка
    image = load_image(file_path)
    
    # 2. Детекция объектов через YOLOv11
    detections = yolo_model.detect(image)
    
    # 3. OCR через EasyOCR
    text_blocks = easyocr.readtext(image)
    
    # 4. Извлечение параметров
    parameters = extract_parameters(text_blocks, detections)
    
    # 5. Сохранение в БД
    await save_drawing_parameters(parameters)
    
    return parameters
```

## Конфигурация и настройки

### API ключи
- Хранятся в переменных окружения
- Ротация ключей через секреты Kubernetes
- Fallback на резервные модели при ошибках

### Параметры моделей
- Temperature для LLM: 0.7 (баланс креативности и точности)
- Top-k для поиска: 5 результатов
- Threshold для OCR: 0.8 (минимальная уверенность)

## Ограничения и известные проблемы

### RAG
- Качество зависит от полноты базы знаний
- Может генерировать галлюцинации при отсутствии релевантного контекста
- Требует регулярного обновления embeddings при добавлении новых расчётов

### OCR
- Точность снижается для рукописного текста
- Проблемы с повёрнутым или искажённым текстом
- Требуется ручная проверка для критичных параметров

### AI-ассистент
- Не заменяет экспертизу инженера
- Требует валидации предложений
- Ограничен контекстом базы знаний

## Метрики и мониторинг

### Отслеживаемые метрики
- Время отклика RAG запросов
- Точность поиска (через feedback пользователей)
- Количество успешных OCR операций
- Использование токенов LLM (для контроля затрат)

### Дашборды
- Grafana дашборды для мониторинга AI компонентов
- Алерты при превышении лимитов API
- Отчёты по использованию моделей

## Будущие улучшения

1. **Fine-tuning моделей** на доменных данных
2. **Мультимодальные модели** для анализа чертежей
3. **Автоматическое обучение** на основе feedback пользователей
4. **Кэширование частых запросов** для снижения затрат

---

**Связанные документы:**
- [Архитектура системы](./system_architecture.md)
- [Технологический стек](./tech_stack.md)
- [Валидация AI компонентов](../testing/ai_validation.md)

