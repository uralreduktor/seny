# Архитектура системы

## Обзор архитектуры

TenderFlow KB AI построена на микросервисной архитектуре с разделением на три основных модуля и общие сервисы.

## Высокоуровневая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend (React)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │
│  │ Tender   │  │ Pricing  │  │ DocFlow  │                 │
│  │  UI      │  │   UI     │  │   UI     │                 │
│  └──────────┘  └──────────┘  └──────────┘                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/REST API
                            │
┌─────────────────────────────────────────────────────────────┐
│                    Backend (FastAPI)                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              API Gateway / Router                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Tender     │  │   Pricing    │  │   DocFlow    │      │
│  │  Management  │  │    KB AI     │  │   Module     │      │
│  │   Module     │  │   Module     │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         Common Services (Auth, Files, etc.)          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼──────┐   ┌───────▼──────┐   ┌───────▼──────┐
│  PostgreSQL  │   │    Redis     │   │    MinIO     │
│  + pgvector  │   │   + Celery   │   │   (S3)       │
└──────────────┘   └──────────────┘   └──────────────┘
        │
        │
┌───────▼──────┐
│  External    │
│  AI Services │
│  (Claude,    │
│   OpenAI)    │
└──────────────┘
```

## Компоненты системы

### Frontend Layer

**Технологии**: React 18, TypeScript 5.3+, Vite, TanStack Query v5

**Структура**:
- Модульные компоненты для каждого функционального модуля
- Общие компоненты (UI kit на базе shadcn/ui)
- API клиенты, сгенерированные из OpenAPI спецификации
- Управление состоянием через TanStack Query

### Backend Layer

**Технологии**: Python 3.11, FastAPI 0.110+, SQLAlchemy 2.0+

**Модули**:

1. **Tender Management Module**
   - Управление жизненным циклом тендеров
   - Импорт с ЭТП
   - Канбан и календарь
   - Уведомления

2. **Pricing KB AI Module**
   - Хранение расчётов стоимости
   - Векторный поиск (RAG)
   - AI-ассистент
   - OCR чертежей

3. **DocFlow Module**
   - Генерация ТКП
   - Автозаполнение форм
   - Комплектование документов
   - Электронная подпись

**Общие сервисы**:
- Аутентификация и авторизация (JWT)
- Управление файлами (интеграция с MinIO)
- Логирование и мониторинг
- Обработка ошибок

### Data Layer

**PostgreSQL 16 + pgvector**
- Основные таблицы (тендеры, расчёты, документы)
- Векторные индексы для embeddings
- Транзакционная целостность данных

**Redis 7**
- Кеширование частых запросов
- Сессии пользователей
- Очереди задач для Celery

**MinIO (S3)**
- Хранение файлов (чертежи, документы, ТКП)
- Версионирование файлов
- Шифрование на уровне хранилища

### AI/ML Layer

**RAG Pipeline**:
1. Генерация embeddings через OpenAI text-embedding-3-large
2. Хранение в pgvector
3. Поиск похожих документов
4. Генерация ответа через Claude 3.5 Sonnet

**OCR Pipeline**:
1. Загрузка чертежа (PDF, DWG, STEP)
2. Детекция объектов через YOLOv11
3. Распознавание текста через EasyOCR
4. Извлечение параметров и сохранение в БД

## Потоки данных

### Сценарий: Поиск похожих расчётов

```
Пользователь → Frontend → API Gateway → Pricing KB AI Module
                                                      │
                                                      ├─→ PostgreSQL (поиск по параметрам)
                                                      ├─→ pgvector (векторный поиск)
                                                      └─→ OpenAI (генерация embedding)
                                                              │
                                                              └─→ Claude 3.5 (RAG ответ)
                                                              │
                                                              └─→ Frontend (отображение результатов)
```

### Сценарий: Обработка чертежа

```
Пользователь → Frontend → API Gateway → Pricing KB AI Module
                                                      │
                                                      ├─→ MinIO (сохранение файла)
                                                      └─→ Celery Task Queue
                                                              │
                                                              └─→ Worker (YOLOv11 + EasyOCR)
                                                              │
                                                              └─→ PostgreSQL (сохранение параметров)
                                                              │
                                                              └─→ Frontend (уведомление о завершении)
```

### Сценарий: Генерация ТКП

```
Пользователь → Frontend → API Gateway → DocFlow Module
                                              │
                                              ├─→ PostgreSQL (получение данных тендера и расчёта)
                                              ├─→ MinIO (получение шаблонов)
                                              └─→ Celery Task Queue
                                                      │
                                                      └─→ Worker (генерация Word/PDF)
                                                      │
                                                      └─→ MinIO (сохранение ТКП)
                                                      │
                                                      └─→ Frontend (уведомление + ссылка на скачивание)
```

## Безопасность

### Аутентификация
- JWT токены для API
- Refresh tokens для обновления сессий
- Ролевая модель доступа (RBAC)

### Шифрование
- TLS для всех соединений
- Шифрование конфиденциальных данных в БД
- Шифрование файлов в MinIO

### Авторизация
- Проверка прав доступа на уровне API endpoints
- Фильтрация данных по ролям пользователей

## Масштабируемость

### Горизонтальное масштабирование
- Stateless backend сервисы (можно запускать несколько инстансов)
- Load balancer перед API Gateway
- Репликация PostgreSQL для чтения
- Redis Cluster для распределённого кеша

### Вертикальное масштабирование
- Оптимизация запросов к БД
- Индексы для частых запросов
- Кеширование результатов тяжёлых вычислений

## Мониторинг и логирование

### Метрики
- Prometheus для сбора метрик
- Grafana для визуализации
- Метрики: время отклика, количество запросов, ошибки, использование ресурсов

### Логирование
- Loki для агрегации логов
- Структурированное логирование (JSON)
- Уровни: DEBUG, INFO, WARNING, ERROR, CRITICAL

## Развёртывание

### Development
- Docker Compose для локальной разработки
- Hot reload для backend и frontend
- Локальные базы данных

### Production
- Kubernetes для оркестрации
- Helm charts для управления конфигурацией
- CI/CD через GitHub Actions или GitLab CI

---

**Связанные документы:**
- [Технологический стек](./tech_stack.md)
- [AI компоненты](./ai_components.md)
- [Развёртывание](../operations/deployment.md)

