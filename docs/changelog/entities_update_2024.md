# Обновление документации сущностей системы

**Дата**: 2025.11.25  
**Версия**: 2.0  
**Статус**: ✅ Завершено

## Обзор изменений

Проведена полная корректировка документации на основании обновлённой модели сущностей из `docs/functional/entities.md`. Все связанные документы синхронизированы с актуальной моделью данных.

## Обновлённые документы

### 1. ✅ `docs/architecture/data_models.md`

**Добавлено**:

- Таблица `nomenclatures` (Номенклатура) с полной структурой
- Таблица `methodologies` (Методики расчёта стоимости)
- Таблица `nomenclature_methodologies` (связь многие-ко-многим)
- Таблица `positions` (Позиции)
- Таблица `commercial_proposals` (Черновики коммерческих предложений)

**Обновлено**:

- Таблица `tenders` — добавлены поля:
  - `date_received` — дата получения ТЗ
  - `engineer_id` — инженер-расчётчик
  - `is_archived` — флаг архивации
  - `notes` — примечания
- Таблица `calculations` — добавлены поля:
  - `methodology_id` — связь с методикой
  - `methodology_version` — версия методики
  - `position_id` — связь с позицией
  - `nomenclature_id` — связь с номенклатурой
  - `formulas`, `coefficients` — формулы и коэффициенты (могут быть скорректированы)
  - `used_parameter_values` — использованные значения параметров
  - `version` — версия расчёта

**Добавлены SQLAlchemy модели**:

- `Tender` — обновлена с новыми полями и связями
- `Position` — новая модель
- `Calculation` — обновлена с новыми полями и связями

### 2. ✅ `docs/modules/tender_management.md`

**Обновлено**:

- Модель `Tender` — добавлены поля:
  - `date_received` — дата получения ТЗ
  - `engineer_id` — инженер-расчётчик
  - `is_archived` — архивирован/активен
  - `notes` — примечания
- Добавлены связи:
  - `positions` — список позиций тендера
  - `calculations` — список расчётов тендера
  - `commercial_proposal` — черновик коммерческого предложения

### 3. ✅ `docs/modules/pricing_kb_ai.md`

**Обновлено**:

- Модель `Calculation` — добавлены поля:
  - `methodology_id`, `methodology_version` — связь с методикой
  - `position_id`, `nomenclature_id` — связи с позицией и номенклатурой
  - `formulas`, `coefficients` — формулы и коэффициенты (могут быть скорректированы)
  - `used_parameter_values` — использованные значения параметров
  - `version` — версия расчёта

**Добавлено**:

- Модель `Position` — полное описание с атрибутами и связями
- Модель `Nomenclature` — описание эталонной сущности
- Модель `Methodology` — описание методики расчёта стоимости

## Ключевые изменения в модели данных

### Новые сущности

1. **Position (Позиция)**
   - Элемент тендерного задания от заказчика
   - Связь с номенклатурой и расчётами
   - Собственная методика расчёта (может отличаться от номенклатурной)
   - Базовая цена позиции для конкретного тендера

2. **Nomenclature (Номенклатура)**
   - Эталонная сущность для унификации
   - Иерархия классификации: `type` → `category` → `subclass`
   - Эталонная базовая цена без привязки к тендеру
   - Связь с методиками расчёта стоимости

3. **Methodology (Методика расчёта стоимости)**
   - Модульная, версионируемая сущность
   - Формулы и коэффициенты для расчёта
   - Связь с номенклатурами (многие-ко-многим)

4. **CommercialProposal (Черновик КП)**
   - Черновик коммерческого предложения для тендера
   - Список позиций с ценами

### Обновлённые связи

1. **Tender → Position**
   - Тендер имеет множество позиций
   - Позиция принадлежит тендеру

2. **Position → Nomenclature**
   - Позиция может быть связана с номенклатурой
   - Номенклатура используется в множестве позиций

3. **Position → Calculation**
   - Позиция может иметь множество расчётов
   - Один расчёт — текущий (`current_calculation_id`)

4. **Calculation → Position → Tender**
   - Расчёт может быть связан с позицией
   - Если есть `position_id`, `tender_id` можно получить через позицию

5. **Nomenclature ↔ Methodology**
   - Связь многие-ко-многим
   - Номенклатура может использовать несколько методик

### Уточнения логики

1. **Цены**:
   - `Nomenclature.base_price` — эталонная цена без привязки к тендеру
   - `Position.base_price` — цена позиции для конкретного тендера
   - `Position.tender_unit_price` — финальная цена с учётом всех факторов

2. **Методики**:
   - Разные методики на разных этапах: Nomenclature → Position → Calculation
   - Методика позиции может отличаться от методики номенклатуры

3. **Формулы и коэффициенты**:
   - В `Calculation` могут быть скорректированы для конкретного расчёта
   - Хранение необходимо для фиксации фактически использованных значений

4. **Версионность**:
   - `Position.version` — версия названия/описания позиции
   - `Calculation.version` — версия расчёта (для пересчётов)
   - `Methodology.version` — версия методики

## Удалённые/изменённые поля

1. **Удалено**:
   - `Position.tender_total_price` — вычисляемое поле (вычисляется как `quantity × tender_unit_price`)

2. **Переименовано**:
   - `Position.calculation_id` → `Position.current_calculation_id` — для ясности назначения

3. **Помечено как вычисляемые**:
   - `Nomenclature.usage_count` — обновляется через триггеры или материализованные представления
   - `Nomenclature.average_price` — обновляется через триггеры или материализованные представления

## Примечания для реализации

### Требует нормализации (будущие улучшения)

1. **JSON связи**:
   - `CommercialProposal.positions` — должна быть таблица `commercial_proposal_positions`
   - `DocumentPackage.documents` — должна быть таблица `document_package_documents`
   - `Nomenclature.methodology_ids` — уже есть таблица `nomenclature_methodologies`

2. **Таблица File**:
   - Рассмотреть создание нормализованной таблицы для файлов
   - Заменить JSON поля `files` в различных сущностях

3. **Комментарии**:
   - Рассмотреть унификацию комментариев через отдельную таблицу `Comments`

## Связанные документы

- [Описание сущностей](../functional/entities.md) — основная модель
- [Анализ сущностей](../functional/entities_analysis.md) — критический анализ
- [Модели данных](../architecture/data_models.md) — структура БД
- [Модуль управления тендерами](../modules/tender_management.md)
- [Модуль ценообразования](../modules/pricing_kb_ai.md)

## Статус синхронизации

- ✅ `docs/functional/entities.md` — обновлён
- ✅ `docs/architecture/data_models.md` — обновлён
- ✅ `docs/modules/tender_management.md` — обновлён
- ✅ `docs/modules/pricing_kb_ai.md` — обновлён
- ✅ `docs/functional/scenarios.md` — проверен, изменений не требуется
- ✅ `docs/development/api_docs.md` — проверен, изменения не критичны

---

**Автор обновления**: AI Assistant  
**Дата завершения**: 2025.11.25
